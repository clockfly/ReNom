image : python:3.6

stages:
  - syntax 
  - cpu-test
  - gpu-test

before_script:
  - apt-get update -qq && apt-get install -y -qq python-pip pandoc
  - pip install numpy flake8 pytest pytest-flake8
  - pip install -r requirements.txt
  - pip install -e .

flake8:
  stage: syntax
  tags:
    - flake8
  script:
    - flake8 .

pytest:
  stage: cpu-test
  tags:
    - cpu 
  script:
    - cd test
    - export RENOM_PRECISION=64
    - USE_CUDA_BACKEND=No pytest

gpus:
  stage: gpu-test
  tags:
    - gpu
  image: darkestduckster/cudnntestimg
  script:
    - apt-get install -y python3 python3-pip
    - pip3 install -r requirements.txt
    - python3 setup.py build_ext -i
    - cd test
    - RENOM_PRECISION=64 USE_CUDA_BACKEND=Yes pytest
